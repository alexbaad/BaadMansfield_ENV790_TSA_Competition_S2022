---
title: "Untitled"
author: "Sarah Mansfield, Alex Baad"
date: "3/27/2022"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r packages, message=F}
library(tseries)
library(forecast)
library(tidyverse)
library(readxl)
```

Goal: Forecast daily demand for January 2011 based on historical data

## Processing the Data

```{r data}
load <- read_excel("data/load.xlsx")
relative_humidity <- read_excel("data/relative_humidity.xlsx")
temperature <- read_excel("data/temperature.xlsx")

# aggregate data
load <- load %>%
  select(-meter_id) %>%
  mutate(daily_avg = rowMeans(select(., starts_with("h")), na.rm = TRUE)) %>%
  select(date, daily_avg)

relative_humidity <- relative_humidity %>%
  mutate(avg = rowMeans(select(., starts_with("rh")), na.rm = TRUE)) %>%
  group_by(date) %>%
  summarise(daily_avg = mean(avg))

temperature <- temperature %>%
  mutate(avg = rowMeans(select(., starts_with("t")), na.rm = TRUE)) %>%
  group_by(date) %>%
  summarise(daily_avg = mean(avg))
```

```{r}
ggplot(load, aes(x = date, y = daily_avg)) +
  geom_line() +
  theme_bw()

ggplot(relative_humidity, aes(x = date, y = daily_avg)) +
  geom_line() +
  theme_bw()

ggplot(temperature, aes(x = date, y = daily_avg)) +
  geom_line() +
  theme_bw()
```


## Creating the Time-Series object

```{r}
load_ts <- msts(load$daily_avg, seasonal.periods = c(7, 365.25), start = c(2005, 1, 1))

load_ts %>%
  mstl() %>%
  autoplot() +
  theme_bw()
```

## Fitting Models and Forecasting for 2010

```{r}
n_for = 365

# training data
load_ts_train <- subset(load_ts, end = length(load_ts) - n_for)
# test data
load_ts_test <- subset(load_ts, start = length(load_ts) - n_for)

autoplot(load_ts_train) +
  theme_bw()
autoplot(load_ts_test) +
  theme_bw()
```

### Model 1: STL + ETS

```{r}
ETS_fit <- stlf(load_ts_train, h=365)

# plot forecast results
autoplot(ETS_fit) + 
  ylab("Active Power") +
  theme_bw()

# plot model + observed data
autoplot(load_ts) +
  autolayer(ETS_fit, series = "STL + ETS", PI = FALSE) +
  ylab("Active Power") +
  theme_bw()
```

## Comparing Models

```{r}
# model 1: STL + ETS
ETS_scores <- accuracy(ETS_fit$mean, load_ts_test)
ETS_scores
```






